# Project Refactor and Bug Fixes - 2025-08-29

This update includes a major architectural refactor and addresses several critical bugs in the voice assistant.

## 1. Architecture: Transition to Multi-Agent System

The entire backend has been restructured from a single monolithic orchestrator into a decoupled, multi-agent system. This addresses the user's core request for a "true multi-agent" architecture.

-   **Agent-Based Design:** Introduced separate, concurrent agents for `WebSocket`, `STT`, `LLM`, and `TTS` processing.
-   **Asyncio Queues:** Agents now communicate via `asyncio.Queue`s, making the system more robust, scalable, and easier to debug.
-   **Decoupled Logic:** Each agent is responsible for only its specific task (e.g., `STTAgent` only handles transcription).

## 2. Backend Bug Fixes

-   **Critical Audio Processing Bug (`_process_audio_buffer`):**
    -   **Fixed:** Implemented the audio conversion logic within the new `STTAgent`.
    -   **Cause:** The browser sends audio in `WebM/Opus` format, but the Whisper model requires raw PCM audio.
    -   **Solution:** The agent now uses the `pydub` library to correctly decode and resample the audio before transcription. This should resolve the issue of VAD/STT not working.

-   **TTS Greeting Uses Fallback (`espeak`):**
    -   **Fixed:** Corrected the `config/settings.yaml` to set `kokoro` as the primary TTS engine.
    -   **Cause:** The configuration was explicitly telling the application to use `espeak`.
    -   **Solution:** The backend now correctly loads the `kokoro` engine first, as specified in the updated config.

-   **Application Crash on Exit (`cleanup`):**
    -   **Fixed:** Implemented the `cleanup` method in the main `VoiceAssistant` class.
    -   **Cause:** The method was called but not defined.
    -   **Solution:** The new `cleanup` method now gracefully stops all running agents and tells the services (STT, TTS, LLM) to release their resources (GPU memory, network connections).

## 3. Frontend UI Fixes

-   **Logs Appearing in Chat Window:**
    -   **Fixed:** Reworked the WebSocket message handler in `script.js`.
    -   **Cause:** All incoming messages were being rendered into the same chat container.
    -   **Solution:** Messages of type `log` are now routed exclusively to the "Logs" tab, while conversational messages appear in the "Chat" tab.

-   **Duplicate Status Display:**
    -   **Fixed:** Removed the redundant status panel from `index.html`.
    -   **Cause:** Two different HTML sections were designated for status updates.
    -   **Solution:** The UI now has a single, clean status section that is updated by the JavaScript.
